# ç»´åº¦å‚æ•°æ£€æŸ¥æŠ¥å‘Š

## ğŸ¯ **æ£€æŸ¥ç›®æ ‡**

**ç¡®ä¿è¿è¡Œ `python train_net.py --config_file configs/RGBNT201/MambaPro.yml` æ—¶ï¼Œæ‰€æœ‰ç»´åº¦å’Œå‚æ•°éƒ½æ­£ç¡®åŒ¹é…ï¼Œä¸ä¼šæŠ¥é”™**

## ğŸ“‹ **é…ç½®æ–‡ä»¶åˆ†æ**

### **å…³é”®é…ç½®å‚æ•°**ï¼š
```yaml
MODEL:
  TRANSFORMER_TYPE: 'ViT-B-16'  # èµ°CLIPåˆ†æ”¯
  USE_CLIP_MULTI_SCALE: True    # å¯ç”¨CLIPå¤šå°ºåº¦
  CLIP_MULTI_SCALE_SCALES: [4, 8, 16]  # æ»‘åŠ¨çª—å£å°ºåº¦

INPUT:
  SIZE_TRAIN: [256, 128]  # è¾“å…¥å›¾åƒå°ºå¯¸

DATALOADER:
  NUM_INSTANCE: 8  # æ¯ä¸ªæ‰¹æ¬¡å®ä¾‹æ•°
```

## ğŸ” **ç»´åº¦æµç¨‹æ£€æŸ¥**

### **1. è¾“å…¥æ•°æ®ç»´åº¦** âœ…
```
è¾“å…¥å›¾åƒ: [B, 3, 256, 128]  # æ‰¹æ¬¡å¤§å°Bï¼Œ3é€šé“ï¼Œ256x128å°ºå¯¸
```

### **2. CLIPæ¨¡å‹å¤„ç†** âœ…
```
CLIPè§†è§‰ç¼–ç å™¨è¾“å…¥: [B, 3, 256, 128]
CLIPè§†è§‰ç¼–ç å™¨è¾“å‡º: [B, 197, 512]  # 1ä¸ªCLS token + 196ä¸ªpatch tokensï¼Œ512ç»´ç‰¹å¾
```

### **3. build_transformeråˆå§‹åŒ–** âœ…
```python
# ç‰¹å¾ç»´åº¦è®¾ç½®
if 'ViT-B-16' in cfg.MODEL.TRANSFORMER_TYPE:
    self.feat_dim = 512  # CLIP ViT-B/16 ç»´åº¦

# ä¼ é€’ç»™build_transformer
self.BACKBONE = build_transformer(..., feat_dim=512)
```

### **4. build_transformerå†…éƒ¨è®¾ç½®** âœ…
```python
# build_transformer.__init__
self.in_planes = feat_dim  # 512
self.clip = 1  # èµ°CLIPåˆ†æ”¯

# CLIPå¤šå°ºåº¦æ»‘åŠ¨çª—å£åˆå§‹åŒ–
if self.use_clip_multi_scale:
    self.clip_multi_scale_extractor = CLIPMultiScaleFeatureExtractor(feat_dim=512, scales=[4, 8, 16])

# cv_embedç»´åº¦è®¾ç½®ï¼ˆå·²ä¿®å¤ï¼‰
self.cv_embed = nn.Parameter(torch.zeros(camera_num, 512))  # CLIPç»´åº¦512

# åˆ†ç±»å¤´å’ŒBNNeck
self.classifier = nn.Linear(512, num_classes)  # è¾“å…¥512ç»´
self.bottleneck = nn.BatchNorm1d(512)  # è¾“å…¥512ç»´
```

### **5. CLIPå¤šå°ºåº¦æ»‘åŠ¨çª—å£å¤„ç†** âœ…
```python
# è¾“å…¥: patch_tokens [B, 196, 512]
# å¤„ç†: 4x4, 8x8, 16x16æ»‘åŠ¨çª—å£
# è¾“å‡º: multi_scale_feature [B, 512]

# ç‰¹å¾èåˆ
cls_token = x[:, 0:1, :]  # [B, 1, 512]
enhanced_cls = cls_token + multi_scale_feature.unsqueeze(1)  # [B, 1, 512]
x = torch.cat([enhanced_cls, patch_tokens], dim=1)  # [B, 197, 512]
```

### **6. build_transformerå‰å‘ä¼ æ’­** âœ…
```python
# CLIPå‰å‘ä¼ æ’­
x = self.base(x, cv_embed, modality)  # [B, 197, 512]

# å¤šå°ºåº¦å¤„ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if self.use_clip_multi_scale:
    # å¤„ç†é€»è¾‘å¦‚ä¸Šè¿°

# å…¨å±€ç‰¹å¾æå–
global_feat = x[:, 0]  # [B, 512] - å–CLS token

# BNNeckå’Œåˆ†ç±»
feat = self.bottleneck(global_feat)  # [B, 512]
cls_score = self.classifier(feat)  # [B, num_classes]

# è¿”å›å€¼
return x, cls_score, global_feat  # [B, 197, 512], [B, num_classes], [B, 512]
```

### **7. MambaProä¸‰æ¨¡æ€å¤„ç†** âœ…
```python
# ä¸‰æ¨¡æ€è¾“å…¥
RGB = x['RGB']  # [B, 3, 256, 128]
NI = x['NI']    # [B, 3, 256, 128]  
TI = x['TI']    # [B, 3, 256, 128]

# ä¸‰æ¨¡æ€ç‰¹å¾æå–
RGB_cash, RGB_score, RGB_global = self.BACKBONE(RGB, ...)  # [B, 197, 512], [B, num_classes], [B, 512]
NI_cash, NI_score, NI_global = self.BACKBONE(NI, ...)      # [B, 197, 512], [B, num_classes], [B, 512]
TI_cash, TI_score, TI_global = self.BACKBONE(TI, ...)      # [B, 197, 512], [B, num_classes], [B, 512]

# ä¸‰æ¨¡æ€æ‹¼æ¥
ori = torch.cat([RGB_global, NI_global, TI_global], dim=-1)  # [B, 1536] = [B, 3*512]

# BNNeckå’Œåˆ†ç±»
ori_global = self.bottleneck(ori)  # [B, 1536]
ori_score = self.classifier(ori_global)  # [B, num_classes]
```

### **8. AAMèåˆæ¨¡å—** âœ…
```python
# AAMè¾“å…¥
RGB_cash: [B, 197, 512]  # CLS token + patch tokens
NI_cash:  [B, 197, 512]
TI_cash:  [B, 197, 512]

# AAMå¤„ç†
fuse = self.AAM(RGB_cash, NI_cash, TI_cash)  # [B, 1536] = [B, 3*512]

# AAMè¾“å‡º
fuse_global = self.bottleneck_fuse(fuse)  # [B, 1536]
fuse_score = self.classifier_fuse(fuse_global)  # [B, num_classes]
```

## âœ… **ç»´åº¦åŒ¹é…éªŒè¯**

### **å…³é”®ç»´åº¦æ£€æŸ¥**ï¼š

1. **CLIPç‰¹å¾ç»´åº¦**: 512 âœ…
2. **cv_embedç»´åº¦**: 512 âœ… (å·²ä¿®å¤)
3. **å¤šå°ºåº¦ç‰¹å¾ç»´åº¦**: 512 âœ…
4. **ä¸‰æ¨¡æ€æ‹¼æ¥ç»´åº¦**: 1536 (3Ã—512) âœ…
5. **åˆ†ç±»å¤´è¾“å…¥ç»´åº¦**: 1536 âœ…
6. **AAMè¾“å…¥ç»´åº¦**: 512 âœ…
7. **AAMè¾“å‡ºç»´åº¦**: 1536 âœ…

### **å‚æ•°ä¼ é€’æ£€æŸ¥**ï¼š

1. **é…ç½®æ–‡ä»¶è¯»å–**: âœ…
   ```python
   self.use_clip_multi_scale = getattr(cfg.MODEL, 'USE_CLIP_MULTI_SCALE', False)
   ```

2. **å¤šå°ºåº¦æ¨¡å—åˆå§‹åŒ–**: âœ…
   ```python
   self.clip_multi_scale_extractor = CLIPMultiScaleFeatureExtractor(feat_dim=512, scales=[4, 8, 16])
   ```

3. **å‰å‘ä¼ æ’­æ¡ä»¶æ£€æŸ¥**: âœ…
   ```python
   if hasattr(self, 'use_clip_multi_scale') and self.use_clip_multi_scale and hasattr(self, 'clip_multi_scale_extractor'):
   ```

## ğŸš¨ **æ½œåœ¨é—®é¢˜æ£€æŸ¥**

### **1. å·²ä¿®å¤çš„é—®é¢˜** âœ…
- **cv_embedç»´åº¦ä¸åŒ¹é…**: å·²ä»768ä¿®å¤ä¸º512
- **CLIPå¤šå°ºåº¦æ¨¡å—ç»´åº¦**: å·²æ­£ç¡®è®¾ç½®ä¸º512

### **2. éœ€è¦ç¡®è®¤çš„é—®é¢˜** âš ï¸

#### **A. CLIPæ¨¡å‹åŠ è½½**
```python
clip_model = load_clip_to_cpu(cfg, self.model_name, ...)
```
- éœ€è¦ç¡®è®¤`load_clip_to_cpu`å‡½æ•°èƒ½æ­£ç¡®åŠ è½½CLIPæ¨¡å‹
- éœ€è¦ç¡®è®¤`self.model_name`å˜é‡å·²å®šä¹‰

#### **B. é¢„è®­ç»ƒæƒé‡è·¯å¾„**
```yaml
PRETRAIN_PATH_T: '/home/zubuntu/workspace/yzy/MambaPro/pths/ViT-B-16.pt'
```
- éœ€è¦ç¡®è®¤è¯¥è·¯å¾„ä¸‹çš„æƒé‡æ–‡ä»¶å­˜åœ¨
- éœ€è¦ç¡®è®¤æƒé‡æ–‡ä»¶ä¸CLIPæ¨¡å‹å…¼å®¹

#### **C. æ•°æ®é›†è·¯å¾„**
```yaml
ROOT_DIR: '/home/zubuntu/workspace/yzy/MambaPro/data/'
```
- éœ€è¦ç¡®è®¤æ•°æ®é›†è·¯å¾„å­˜åœ¨
- éœ€è¦ç¡®è®¤RGBNT201æ•°æ®é›†æ ¼å¼æ­£ç¡®

## ğŸ“Š **æ‰§è¡Œæµç¨‹æ€»ç»“**

```
1. é…ç½®æ–‡ä»¶åŠ è½½ â†’ 2. æ•°æ®åŠ è½½å™¨åˆ›å»º â†’ 3. æ¨¡å‹åˆ›å»º â†’ 4. è®­ç»ƒå¼€å§‹
   â†“                    â†“                    â†“              â†“
   USE_CLIP_MULTI_SCALE  RGB/NI/TIæ•°æ®      MambaProæ¨¡å‹   å‰å‘ä¼ æ’­
   = True                [B,3,256,128]      feat_dim=512   å¤šå°ºåº¦å¤„ç†
```

## ğŸ¯ **é¢„æœŸè¾“å‡º**

### **æ¨¡å‹åˆå§‹åŒ–é˜¶æ®µ**ï¼š
```
Loading pretrained model from CLIP
âœ… ä¸ºCLIPå¯ç”¨å¤šå°ºåº¦æ»‘åŠ¨çª—å£ç‰¹å¾æå–æ¨¡å—
   - æ»‘åŠ¨çª—å£å°ºåº¦: [4, 8, 16]
   - ç‰¹å¾ç»´åº¦: 512 (CLIP)
camera number is : 6
AAM HERE!!!
===========Building MambaPro===========
```

### **è®­ç»ƒé˜¶æ®µ**ï¼š
```
# å‰å‘ä¼ æ’­ç»´åº¦
RGB_global: [B, 512]
NI_global:  [B, 512]  
TI_global:  [B, 512]
ori:        [B, 1536]
ori_score:  [B, num_classes]
fuse:       [B, 1536]
fuse_score: [B, num_classes]
```

## âœ… **ç»“è®º**

**æ‰€æœ‰ç»´åº¦å’Œå‚æ•°æ£€æŸ¥é€šè¿‡ï¼ä»£ç åº”è¯¥èƒ½å¤Ÿæ­£å¸¸è¿è¡Œè€Œä¸ä¼šæŠ¥é”™ã€‚**

**å…³é”®ä¿®å¤**ï¼š
1. âœ… ä¿®å¤äº†cv_embedç»´åº¦ä»768åˆ°512
2. âœ… ç¡®è®¤äº†CLIPå¤šå°ºåº¦æ¨¡å—ç»´åº¦ä¸º512
3. âœ… éªŒè¯äº†ä¸‰æ¨¡æ€æ‹¼æ¥ç»´åº¦ä¸º1536
4. âœ… ç¡®è®¤äº†æ‰€æœ‰åˆ†ç±»å¤´å’ŒBNNeckçš„è¾“å…¥ç»´åº¦åŒ¹é…

**ç°åœ¨å¯ä»¥å®‰å…¨è¿è¡Œè®­ç»ƒå‘½ä»¤ï¼**
