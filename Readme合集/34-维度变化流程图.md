# 维度变化流程图

## 🎯 完整维度变化流程图

```
输入图像处理阶段
┌─────────────────────────────────────────────────────────────┐
│ 输入图像: [B, 3, 256, 128]                                 │
│     ↓                                                      │
│ CLIP Conv2d (16×16, stride=16)                             │
│     ↓                                                      │
│ 输出: [B, 768, 16, 8]  # 128个patch，每个768维            │
└─────────────────────────────────────────────────────────────┘
                              ↓
CLIP视觉编码器处理阶段
┌─────────────────────────────────────────────────────────────┐
│ [B, 768, 16, 8]                                            │
│     ↓                                                      │
│ reshape: [B, 768, 128]  # 展平空间维度                    │
│     ↓                                                      │
│ permute: [B, 128, 768]  # 转换为序列格式                  │
│     ↓                                                      │
│ 添加CLS token: [B, 129, 768]  # 128个patch + 1个CLS      │
│     ↓                                                      │
│ 位置编码: [B, 129, 768]  # 添加位置信息                   │
│     ↓                                                      │
│ Transformer处理: [B, 129, 768]  # 12层Transformer         │
│     ↓                                                      │
│ LayerNorm: [B, 129, 768]  # 后处理归一化                  │
│     ↓                                                      │
│ 投影层: [B, 129, 512]  # 768维 → 512维投影                │
└─────────────────────────────────────────────────────────────┘
                              ↓
Token分离阶段
┌─────────────────────────────────────────────────────────────┐
│ CLIP输出: [B, 129, 512]                                    │
│     ↓                                                      │
│ 分离操作:                                                  │
│     ├── CLS token: [B, 1, 512]     # 全局特征             │
│     └── Patch tokens: [B, 128, 512] # 局部特征            │
└─────────────────────────────────────────────────────────────┘
                              ↓
多尺度滑动窗口处理阶段
┌─────────────────────────────────────────────────────────────┐
│ Patch tokens: [B, 128, 512]                                │
│     ↓                                                      │
│ 转置: [B, 512, 128]  # 为1D卷积准备                       │
│     ↓                                                      │
│ 多尺度滑动窗口处理:                                        │
│     ├── 4x4窗口: [B, 512, 32] → 全局池化 → [B, 512]      │
│     ├── 8x8窗口: [B, 512, 16] → 全局池化 → [B, 512]      │
│     └── 16x16窗口: [B, 512, 8] → 全局池化 → [B, 512]     │
│     ↓                                                      │
│ 特征融合:                                                  │
│     ├── MLP方式: [B, 1536] → MLP → [B, 512]              │
│     └── MoE方式: [B, 1536] → 门控网络 → 专家网络 → [B, 512] │
└─────────────────────────────────────────────────────────────┘
                              ↓
特征增强与重组阶段
┌─────────────────────────────────────────────────────────────┐
│ 多尺度特征: [B, 512]                                       │
│     ↓                                                      │
│ 与CLS token结合:                                           │
│     ├── CLS token: [B, 1, 512]                            │
│     ├── 多尺度特征: [B, 512] → unsqueeze → [B, 1, 512]    │
│     └── 残差连接: [B, 1, 512] + [B, 1, 512] = [B, 1, 512] │
│     ↓                                                      │
│ 重新组合tokens:                                            │
│     ├── 增强CLS: [B, 1, 512]                              │
│     └── 原始Patch: [B, 128, 512]                          │
│     ↓                                                      │
│ 最终输出: [B, 129, 512]  # 1个CLS + 128个patch           │
└─────────────────────────────────────────────────────────────┘
                              ↓
全局特征提取阶段
┌─────────────────────────────────────────────────────────────┐
│ Token序列: [B, 129, 512]                                   │
│     ↓                                                      │
│ 取CLS token: [B, 512]  # 第0个token作为全局特征           │
│     ↓                                                      │
│ BNNeck处理: [B, 512]  # BatchNorm1d归一化                 │
│     ↓                                                      │
│ 最终特征: [B, 512]  # 用于分类和检索                      │
└─────────────────────────────────────────────────────────────┘
```

## 🔥 MoE融合详细流程

```
多尺度特征融合 (MoE方式)
┌─────────────────────────────────────────────────────────────┐
│ 多尺度特征列表:                                             │
│     ├── 4x4特征: [B, 512]                                 │
│     ├── 8x8特征: [B, 512]                                 │
│     └── 16x16特征: [B, 512]                               │
│     ↓                                                      │
│ 特征拼接: [B, 1536]  # 3×512=1536                         │
│     ↓                                                      │
│ 门控网络:                                                  │
│     ├── 输入: [B, 1536]                                   │
│     ├── 隐藏层: [B, 768] → [B, 3]                         │
│     └── 输出: [B, 3]  # 专家权重分布                      │
│     ↓                                                      │
│ 专家网络处理:                                              │
│     ├── 专家1(4x4): [B, 512] → [B, 1024] → [B, 512]      │
│     ├── 专家2(8x8): [B, 512] → [B, 1024] → [B, 512]      │
│     └── 专家3(16x16): [B, 512] → [B, 1024] → [B, 512]    │
│     ↓                                                      │
│ 加权融合:                                                  │
│     ├── 权重广播: [B, 3] → [B, 512]                       │
│     ├── 逐元素乘法: weight * expert_output                 │
│     └── 求和: [B, 512]  # 最终融合特征                    │
│     ↓                                                      │
│ 最终融合层: [B, 512] → [B, 512]  # 后处理                 │
└─────────────────────────────────────────────────────────────┘
```

## 📊 关键维度变化点总结

| 阶段 | 输入维度 | 输出维度 | 关键操作 | 维度变化说明 |
|------|----------|----------|----------|--------------|
| **图像输入** | [B, 3, 256, 128] | [B, 768, 16, 8] | Conv2d | 3→768维，空间16×8 |
| **序列化** | [B, 768, 16, 8] | [B, 128, 768] | reshape+permute | 2D→1D序列，128个patch |
| **添加CLS** | [B, 128, 768] | [B, 129, 768] | concat | 128→129个tokens |
| **投影降维** | [B, 129, 768] | [B, 129, 512] | Linear | 768→512维特征 |
| **多尺度处理** | [B, 128, 512] | [B, 512] | 滑动窗口+融合 | 128个patch→1个特征 |
| **特征增强** | [B, 1, 512] + [B, 512] | [B, 1, 512] | 残差连接 | 信息融合增强 |
| **最终特征** | [B, 129, 512] | [B, 512] | 索引+BN | 提取全局特征 |

## 🎯 不同配置的维度变化对比

### 配置1：基线方法
```
[B, 3, 256, 128] → CLIP → [B, 129, 512] → 取CLS → [B, 512]
```

### 配置2：多尺度滑动窗口
```
[B, 3, 256, 128] → CLIP → [B, 129, 512] → 多尺度处理 → [B, 512] → 特征增强 → [B, 512]
```

### 配置3：多尺度滑动窗口 + MoE
```
[B, 3, 256, 128] → CLIP → [B, 129, 512] → MoE处理 → [B, 512] → 特征增强 → [B, 512]
```

## 💡 维度设计要点

1. **512维特征空间**: 平衡表达能力和计算效率
2. **129个tokens**: 1个CLS + 128个patch，保持序列结构
3. **多尺度融合**: 3个尺度特征拼接为1536维，融合回512维
4. **残差连接**: 保持梯度流和信息传递
5. **维度一致性**: 各阶段输入输出维度匹配

通过这个完整的维度变化流程，可以清楚地看到从输入图像到最终特征的每一步维度变化，有助于理解整个系统的设计思路和实现细节。
