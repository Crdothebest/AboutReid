# 实验命令行操作指南

## 📋 目录
- [基础实验命令](#基础实验命令)
- [消融实验命令](#消融实验命令)
- [参数调优实验命令](#参数调优实验命令)
- [实验记录命令](#实验记录命令)
- [结果分析命令](#结果分析命令)

---

## 🚀 基础实验命令

### 1. 环境准备
```bash
# 激活conda环境
conda activate MambaPro

# 进入项目目录
cd /home/zubuntu/workspace/yzy/MambaPro
```

### 2. 基线实验
```bash
# 基线实验（无多尺度，无MoE）
python train_net.py --config_file configs/RGBNT201/MambaPro.yml --disable_moe

# 仅多尺度滑动窗口实验
python train_net.py --config_file configs/RGBNT201/MambaPro.yml --disable_moe --use_multi_scale

# 多尺度滑动窗口 + MoE实验
python train_net.py --config_file configs/RGBNT201/MambaPro.yml --use_moe

# ✨✨ 优化MoE实验（使用优化配置）
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml
```

---

## 🔬 消融实验命令

### 1. 单尺度滑动窗口消融
```bash
# 仅4×4小尺度滑动窗口
python train_net.py --config_file configs/RGBNT201/ablation_scale4_only.yml

# 仅8×8中尺度滑动窗口
python train_net.py --config_file configs/RGBNT201/ablation_scale8_only.yml

# 仅16×16大尺度滑动窗口
python train_net.py --config_file configs/RGBNT201/ablation_scale16_only.yml
```

### 2. 多尺度组合消融
```bash
# 2尺度组合（4×4 + 8×8）
python train_net.py --config_file configs/RGBNT201/ablation_scale4_8.yml

# 2尺度组合（4×4 + 16×16）
python train_net.py --config_file configs/RGBNT201/ablation_scale4_16.yml

# 2尺度组合（8×8 + 16×16）
python train_net.py --config_file configs/RGBNT201/ablation_scale8_16.yml

# 完整3尺度组合
python train_net.py --config_file configs/RGBNT201/MambaPro.yml --use_moe
```

### 3. MoE消融实验
```bash
# 仅多尺度滑动窗口（无MoE）
python train_net.py --config_file configs/RGBNT201/MambaPro.yml --disable_moe --use_multi_scale

# 多尺度 + MoE（完整方法）
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml
```

---

## ⚙️ 参数调优实验命令

### 1. 学习率调优
```bash
# 低学习率实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --base_lr 0.0002

# 高学习率实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --base_lr 0.0008

# 超低学习率实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --base_lr 0.0001
```

### 2. 训练轮数调优
```bash
# 短训练实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --max_epochs 40

# 长训练实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --max_epochs 100

# 超长训练实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --max_epochs 120
```

### 3. 批次大小调优
```bash
# 小批次实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --ims_per_batch 16

# 大批次实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --ims_per_batch 64

# 超大批次实验
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --ims_per_batch 128
```

### 4. MoE参数调优
```bash
# 专家网络维度调优
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --moe_expert_hidden_dim 512
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --moe_expert_hidden_dim 2048

# 温度参数调优
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --moe_temperature 0.3
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --moe_temperature 1.2
```

---

## 📝 实验记录命令

### 1. 基础记录
```bash
# 记录基线实验
python quick_experiment_log.py configs/RGBNT201/MambaPro.yml "baseline_experiment"

# 记录多尺度实验
python quick_experiment_log.py configs/RGBNT201/MambaPro.yml "multi_scale_experiment"

# 记录MoE实验
python quick_experiment_log.py configs/RGBNT201/MambaPro_moe.yml "moe_experiment"
```

### 2. 参数覆盖记录
```bash
# 记录基础实验（所有参数）
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "baseline_experiment"

# 记录多尺度实验（启用多尺度）
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "multi_scale_experiment" --use_multi_scale

# 记录MoE实验（启用MoE）
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "moe_experiment" --use_moe

# 记录自定义参数实验
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "custom_experiment" --use_moe --base_lr 0.0003 --max_epochs 80 --moe_expert_hidden_dim 512 --moe_temperature 0.5
```

### 3. 参数调优记录
```bash
# 学习率调优记录
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "lr_tuning_experiment" --use_moe --base_lr 0.0002

# 专家维度调优记录
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "expert_dim_tuning" --use_moe --moe_expert_hidden_dim 2048

# 温度参数调优记录
python parameter_override_logger.py configs/RGBNT201/MambaPro.yml "temperature_tuning" --use_moe --moe_temperature 0.3
```

### 4. 增强记录
```bash
# 使用增强记录器
python enhanced_experiment_logger.py configs/RGBNT201/MambaPro_moe.yml "moe_optimization_experiment" --use_moe
```

---

## 📊 结果分析命令

### 1. 查看实验记录
```bash
# 查看所有实验记录
ls experiment_logs/

# 查看实验总结
python quick_experiment_log.py

# 查看具体实验记录
cat experiment_logs/baseline_experiment_20240926_143022.json
```

### 2. 结果对比分析
```bash
# 生成对比表格
python -c "
import json
import pandas as pd

# 读取实验记录
experiments = []
with open('experiment_logs/all_experiments.jsonl', 'r') as f:
    for line in f:
        experiments.append(json.loads(line))

# 创建对比表格
df = pd.DataFrame(experiments)
print(df[['experiment_name', 'results']].to_string())
"
```

### 3. 可视化分析
```bash
# 生成训练曲线
python -c "
import matplotlib.pyplot as plt
import json

# 读取训练进度
with open('experiment_logs/training_progress.jsonl', 'r') as f:
    progress = [json.loads(line) for line in f]

# 绘制损失曲线
epochs = [p['epoch'] for p in progress]
losses = [p['loss'] for p in progress]

plt.plot(epochs, losses)
plt.title('Training Loss Curve')
plt.xlabel('Epoch')
plt.ylabel('Loss')
plt.savefig('training_curve.png')
plt.show()
"
```

---

## 🔧 高级实验命令

### 1. 并行实验
```bash
# 同时运行多个实验（后台运行）
nohup python train_net.py --config_file configs/RGBNT201/MambaPro.yml --disable_moe > baseline.log 2>&1 &
nohup python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml > moe.log 2>&1 &
```

### 2. 恢复训练
```bash
# 从检查点恢复训练
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --resume outputs/moe_optimized_experiment/checkpoint_epoch_30.pth
```

### 3. 仅测试模式
```bash
# 仅测试已训练模型
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --test_only --weight outputs/moe_optimized_experiment/best_model.pth
```

### 4. 自定义输出目录
```bash
# 指定输出目录
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --output_dir outputs/custom_experiment
```

---

## 📋 实验检查清单

### 实验前检查
- [ ] 确认conda环境已激活
- [ ] 确认配置文件存在
- [ ] 确认数据集路径正确
- [ ] 确认GPU可用
- [ ] 确认输出目录权限

### 实验中监控
- [ ] 监控GPU使用率：`nvidia-smi`
- [ ] 监控训练进度：查看日志输出
- [ ] 监控内存使用：`htop`
- [ ] 监控磁盘空间：`df -h`

### 实验后分析
- [ ] 检查实验结果文件
- [ ] 对比性能指标
- [ ] 分析训练曲线
- [ ] 记录实验发现
- [ ] 更新实验记录

---

## 🚨 常见问题解决

### 1. 内存不足
```bash
# 减少批次大小
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --ims_per_batch 16

# 减少专家网络维度
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --moe_expert_hidden_dim 512
```

### 2. 训练不稳定
```bash
# 降低学习率
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --base_lr 0.0002

# 增加预热轮数
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --warmup_iters 40
```

### 3. 收敛慢
```bash
# 提高学习率
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --base_lr 0.0008

# 增加训练轮数
python train_net.py --config_file configs/RGBNT201/MambaPro_moe.yml --max_epochs 100
```

---

## 📚 实验记录模板

### 实验记录格式
```markdown
# 实验记录：{experiment_name}

## 基本信息
- 实验时间：{timestamp}
- 配置文件：{config_file}
- 实验参数：{parameters}

## 实验结果
- mAP：{mAP}%
- Rank-1：{Rank-1}%
- 训练时间：{training_time}

## 分析结论
- 主要发现：{findings}
- 技术贡献：{contributions}
- 改进建议：{improvements}
```

---

## 🎯 最佳实践建议

### 1. 实验顺序
1. 先运行基线实验
2. 再运行消融实验
3. 最后运行参数调优实验

### 2. 参数记录
1. 使用参数覆盖记录器
2. 记录所有关键参数
3. 保存实验配置副本

### 3. 结果分析
1. 及时分析实验结果
2. 对比不同配置性能
3. 记录实验发现

### 4. 实验管理
1. 使用统一的命名规范
2. 定期备份实验记录
3. 维护实验日志

---

*最后更新：2024-09-26*
*版本：v1.0*
