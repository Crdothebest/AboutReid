# ä»£ç æ‰§è¡Œæµç¨‹åˆ†æ

## ğŸ¯ **æ‰§è¡Œå‘½ä»¤**
```bash
python train_net.py --config_file configs/RGBNT201/MambaPro.yml
```

## ğŸ”„ **å®Œæ•´æ‰§è¡Œæµç¨‹**

### **1. å¯åŠ¨é˜¶æ®µ (train_net.py)**

```python
# 1. è§£æå‘½ä»¤è¡Œå‚æ•°
parser.add_argument("--config_file", default="...", help="path to config file", type=str)
args = parser.parse_args()

# 2. åŠ è½½é…ç½®æ–‡ä»¶
cfg.merge_from_file(args.config_file)  # åŠ è½½ configs/RGBNT201/MambaPro.yml
cfg.freeze()  # å†»ç»“é…ç½®

# 3. è®¾ç½®éšæœºç§å­
set_seed(cfg.SOLVER.SEED)
```

### **2. æ•°æ®åŠ è½½é˜¶æ®µ**

```python
# 4. åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_loader, train_loader_normal, val_loader, num_query, num_classes, camera_num, view_num = make_dataloader(cfg)
```

**æ•°æ®æµç¨‹**ï¼š
- åŠ è½½RGBNT201æ•°æ®é›†
- åˆ›å»ºRGBã€NIRã€TIä¸‰æ¨¡æ€æ•°æ®åŠ è½½å™¨
- è¿”å›è®­ç»ƒå’ŒéªŒè¯æ•°æ®

### **3. æ¨¡å‹åˆ›å»ºé˜¶æ®µ (å…³é”®)**

```python
# 5. åˆ›å»ºæ¨¡å‹
model = make_model(cfg, num_class=num_classes, camera_num=camera_num, view_num=view_num)
```

#### **æ¨¡å‹åˆ›å»ºè¯¦ç»†æµç¨‹**ï¼š

**æ­¥éª¤1**: `make_model()` å‡½æ•°è°ƒç”¨
```python
def make_model(cfg, num_class, camera_num, view_num=0):
    model = MambaPro(num_class, cfg, camera_num, view_num, __factory_T_type)
    return model
```

**æ­¥éª¤2**: `MambaPro` ç±»åˆå§‹åŒ–
```python
class MambaPro(nn.Module):
    def __init__(self, num_classes, cfg, camera_num, view_num, factory):
        # æ ¹æ®TRANSFORMER_TYPEç¡®å®šç‰¹å¾ç»´åº¦
        if 'ViT-B-16' in cfg.MODEL.TRANSFORMER_TYPE:
            self.feat_dim = 512  # CLIP ViT-B/16 ç»´åº¦
        
        # åˆ›å»ºå…±äº«éª¨å¹²ç½‘ç»œ
        self.BACKBONE = build_transformer(num_classes, cfg, camera_num, view_num, factory, feat_dim=self.feat_dim)
```

**æ­¥éª¤3**: `build_transformer` ç±»åˆå§‹åŒ–
```python
class build_transformer(nn.Module):
    def __init__(self, num_classes, cfg, camera_num, view_num, factory, feat_dim):
        # è¯»å–å¤šå°ºåº¦é…ç½®
        self.use_multi_scale = getattr(cfg.MODEL, 'USE_MULTI_SCALE', False)  # True
        
        # æ ¹æ®TRANSFORMER_TYPEåˆ›å»ºæ¨¡å‹
        if cfg.MODEL.TRANSFORMER_TYPE in ['vit_base_patch16_224', 'ViT-B-16']:
            # åˆ›å»ºViT-B-16æ¨¡å‹
            self.base = factory[cfg.MODEL.TRANSFORMER_TYPE](...)  # è°ƒç”¨vit_base_patch16_224
            
            # å¤šå°ºåº¦æ»‘åŠ¨çª—å£åˆå§‹åŒ–
            if self.use_multi_scale:  # True
                from ..fusion_part.multi_scale_sliding_window import MultiScaleFeatureExtractor
                feat_dim = self.base.embed_dim  # 768
                self.multi_scale_extractor = MultiScaleFeatureExtractor(feat_dim, scales=[4, 8, 16])
                print('âœ… ä¸ºViT-B-16å¯ç”¨å¤šå°ºåº¦æ»‘åŠ¨çª—å£ç‰¹å¾æå–æ¨¡å—')
```

### **4. æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨åˆ›å»º**

```python
# 6. åˆ›å»ºæŸå¤±å‡½æ•°
loss_func, center_criterion = make_loss(cfg, num_classes=num_classes)

# 7. åˆ›å»ºä¼˜åŒ–å™¨
optimizer, optimizer_center = make_optimizer(cfg, model, center_criterion)

# 8. åˆ›å»ºå­¦ä¹ ç‡è°ƒåº¦å™¨
scheduler = create_scheduler(cfg, optimizer)
```

### **5. è®­ç»ƒé˜¶æ®µ**

```python
# 9. å¼€å§‹è®­ç»ƒ
do_train(cfg, model, center_criterion, train_loader, val_loader, 
         optimizer, optimizer_center, scheduler, loss_func, num_query, args.local_rank)
```

## ğŸ” **å¤šå°ºåº¦æ»‘åŠ¨çª—å£é›†æˆç‚¹**

### **é›†æˆä½ç½®1: æ¨¡å‹åˆå§‹åŒ–**
```python
# åœ¨ build_transformer.__init__ ä¸­
if self.use_multi_scale:
    self.multi_scale_extractor = MultiScaleFeatureExtractor(feat_dim, scales=[4, 8, 16])
```

### **é›†æˆä½ç½®2: å‰å‘ä¼ æ’­**
```python
# åœ¨ build_transformer.forward ä¸­
if self.clip == 0:  # ViTåˆ†æ”¯
    x = self.base(x, cam_label=cam_label, view_label=view_label, modality=modality)
    
    # å¤šå°ºåº¦æ»‘åŠ¨çª—å£å¤„ç†
    if hasattr(self, 'use_multi_scale') and self.use_multi_scale:
        cls_token = x[:, 0:1, :]  # åˆ†ç¦»CLS token
        patch_tokens = x[:, 1:, :]  # åˆ†ç¦»patch tokens
        
        # å¤šå°ºåº¦ç‰¹å¾æå–
        multi_scale_feature = self.multi_scale_extractor(patch_tokens)
        
        # ç‰¹å¾èåˆ
        enhanced_cls = cls_token + multi_scale_feature.unsqueeze(1)
        x = torch.cat([enhanced_cls, patch_tokens], dim=1)
```

### **é›†æˆä½ç½®3: å¤šæ¨¡æ€èåˆ**
```python
# åœ¨ MambaPro.forward ä¸­
RGB_cash, RGB_score, RGB_global = self.BACKBONE(RGB, cam_label=cam_label, view_label=view_label, modality='rgb')
NI_cash, NI_score, NI_global = self.BACKBONE(NI, cam_label=cam_label, view_label=view_label, modality='nir')
TI_cash, TI_score, TI_global = self.BACKBONE(TI, cam_label=cam_label, view_label=view_label, modality='tir')

# æ¯ä¸ªæ¨¡æ€éƒ½ç»è¿‡å¤šå°ºåº¦æ»‘åŠ¨çª—å£å¤„ç†
```

## âœ… **æ‰§è¡Œæµç¨‹éªŒè¯**

### **é…ç½®éªŒè¯**ï¼š
- âœ… `TRANSFORMER_TYPE: 'ViT-B-16'` â†’ æ˜ å°„åˆ° `vit_base_patch16_224`
- âœ… `USE_MULTI_SCALE: True` â†’ å¯ç”¨å¤šå°ºåº¦æ»‘åŠ¨çª—å£
- âœ… `MULTI_SCALE_SCALES: [4, 8, 16]` â†’ æ»‘åŠ¨çª—å£å°ºåº¦

### **ä»£ç è·¯å¾„éªŒè¯**ï¼š
- âœ… `ViT-B-16` â†’ `__factory_T_type['ViT-B-16']` â†’ `vit_base_patch16_224`
- âœ… `build_transformer` â†’ `ViT-B-16` åˆ†æ”¯ â†’ å¤šå°ºåº¦åˆå§‹åŒ–
- âœ… `forward` â†’ `self.clip == 0` â†’ å¤šå°ºåº¦å¤„ç†

### **æ¨¡å—å¯¼å…¥éªŒè¯**ï¼š
- âœ… `from ..fusion_part.multi_scale_sliding_window import MultiScaleFeatureExtractor`
- âœ… å¤šå°ºåº¦æ¨¡å—æ–‡ä»¶å­˜åœ¨ä¸”å¯å¯¼å…¥

## ğŸš¨ **æ½œåœ¨é—®é¢˜æ£€æŸ¥**

### **é—®é¢˜1: ç‰¹å¾ç»´åº¦ä¸åŒ¹é…**
- **é…ç½®**: `ViT-B-16` â†’ `feat_dim = 512`
- **å®é™…**: `vit_base_patch16_224` â†’ `embed_dim = 768`
- **è§£å†³**: ä»£ç ä¸­åŠ¨æ€è·å– `self.base.embed_dim`

### **é—®é¢˜2: é¢„è®­ç»ƒæƒé‡è·¯å¾„**
- **é…ç½®**: `PRETRAIN_PATH_T: '/home/zubuntu/workspace/yzy/MambaPro/pths/ViT-B-16.pt'`
- **æ£€æŸ¥**: éœ€è¦ç¡®ä¿æƒé‡æ–‡ä»¶å­˜åœ¨

### **é—®é¢˜3: è¾“å‡ºç›®å½•æƒé™**
- **é…ç½®**: `OUTPUT_DIR: '/home/zubuntu/workspace/yzy/MambaPro/outputs/multi_scale_experiment'`
- **æ£€æŸ¥**: éœ€è¦ç¡®ä¿ç›®å½•å¯å†™

## ğŸ¯ **é¢„æœŸæ‰§è¡Œç»“æœ**

### **æˆåŠŸæ ‡å¿—**ï¼š
1. âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ
2. âœ… æ•°æ®åŠ è½½å™¨åˆ›å»ºæˆåŠŸ
3. âœ… æ¨¡å‹åˆ›å»ºæˆåŠŸï¼Œæ˜¾ç¤ºå¤šå°ºåº¦æ¨¡å—å¯ç”¨ä¿¡æ¯
4. âœ… æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨åˆ›å»ºæˆåŠŸ
5. âœ… è®­ç»ƒå¼€å§‹ï¼Œæ˜¾ç¤ºè®­ç»ƒè¿›åº¦

### **å…³é”®è¾“å‡ºä¿¡æ¯**ï¼š
```
âœ… ä¸ºViT-B-16å¯ç”¨å¤šå°ºåº¦æ»‘åŠ¨çª—å£ç‰¹å¾æå–æ¨¡å—
   - æ»‘åŠ¨çª—å£å°ºåº¦: [4, 8, 16]
   - ç‰¹å¾ç»´åº¦: 768
Loading pretrained model from ImageNet
===========Building MambaPro===========
```

## ğŸ”§ **æ•…éšœæ’é™¤**

### **å¦‚æœå‡ºç°é”™è¯¯**ï¼š
1. **æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„**: ç¡®ä¿ `configs/RGBNT201/MambaPro.yml` å­˜åœ¨
2. **æ£€æŸ¥é¢„è®­ç»ƒæƒé‡**: ç¡®ä¿ `ViT-B-16.pt` æ–‡ä»¶å­˜åœ¨
3. **æ£€æŸ¥è¾“å‡ºç›®å½•**: ç¡®ä¿è¾“å‡ºç›®å½•å¯å†™
4. **æ£€æŸ¥ä¾èµ–**: ç¡®ä¿æ‰€æœ‰PythonåŒ…å·²å®‰è£…

### **è°ƒè¯•å»ºè®®**ï¼š
1. å…ˆè¿è¡Œ `python test_multi_scale_integration.py` éªŒè¯æ¨¡å—
2. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ç¡®å®šå…·ä½“é—®é¢˜

## ğŸ“Š **æ€»ç»“**

ä»£ç æ‰§è¡Œæµç¨‹è®¾è®¡åˆç†ï¼Œå¤šå°ºåº¦æ»‘åŠ¨çª—å£å·²æ­£ç¡®é›†æˆåˆ°æ•´ä¸ªè®­ç»ƒæµç¨‹ä¸­ï¼š

1. **é…ç½®åŠ è½½** â†’ è¯»å–å¤šå°ºåº¦è®¾ç½®
2. **æ¨¡å‹åˆ›å»º** â†’ åˆå§‹åŒ–å¤šå°ºåº¦æ¨¡å—
3. **å‰å‘ä¼ æ’­** â†’ åº”ç”¨å¤šå°ºåº¦å¤„ç†
4. **è®­ç»ƒå¾ªç¯** â†’ ç«¯åˆ°ç«¯è®­ç»ƒ

æ•´ä¸ªæµç¨‹åº”è¯¥èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œå¤šå°ºåº¦æ»‘åŠ¨çª—å£åŠŸèƒ½å·²å®Œå…¨èå…¥ä»£ç æ¶æ„ä¸­ã€‚
